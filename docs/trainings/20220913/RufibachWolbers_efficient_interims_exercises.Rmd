---
title: "Advanced group-sequential and adaptive confirmatory clinical trial designs, with R practicals using rpact: Efficient use of futility and efficacy interim analyses in group-sequential designs: exercises"
author: 
- name: "Kaspar Rufibach"
  affiliation: Methods, Collaboration, and Outraech Gropu (MCO), PD Data and Statistical Sciences, Roche Basel
date: "Last change: `r format(Sys.time(), '%d %B, %Y')`"
output: 
  rmarkdown::html_document:
    highlight: pygments
    number_sections: yes
    self_contained: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
    code_download: true
---

# Purpose of this document

This R markdown file provides the code accompanying the exercises of first theory block in the BBS course [Advanced group-sequential and adaptive confirmatory clinical trial designs, with R practicals using rpact](https://baselbiometrics.github.io/home/docs/trainings/20220913/agenda.pdf).

# Getting started

- Make sure that you have the latest version of `rpact` installed.
- Download the raw R markdown exercise file by clicking on the "code" block of the right upper corner [here](https://baselbiometrics.github.io/home/docs/trainings/20220913/RufibachWolbers_efficient_interims_exercises.html).
- Start up your local Rstudio installation. Then open the R markdown exercise file.
- Start answering the questions below by adding text or your own `R` code. Use the `rpact` help for guidance.

$\Rightarrow$ **Good Luck!**

# Load `rpact` 

```{r, include=TRUE, echo=TRUE}
# Load bpp and rpact
library(rpact)
```

# Trial with OS endpoint

Assume we plan a phase III, randomized, multicenter, open-label, two-arm trial with a time-to-event endpoint of OS. The **general assumptions for the sample size assessment** are:

- 2:1 randomization.
- The dropout rate is 5% in both arms over 12 months.
- The recruitment of 480 patients will take place over 10 months. 

The **sample size section for OS** states that the following additional assumptions were made:

- Exponentially distributed OS in the control arm with a median of 12 months.
- Median OS improvement vs. control of 4.9 months (medians 16.9 vs. 12 months, i.e. a HR of approximately 0.71).
- Log-rank test at a two-sided significance level of 0.05, power 80%.
- One interim analyses for efficacy (IA) and one final analysis using the O\'Brien-Fleming boundaries approximated using the Lan-DeMets method. The first IA will be performed after 60% of information. 

## Question 1

*Calculate the required number of events and timing of analysis for OS using the information fraction of 60%. Use the `rpact` functions `getDesignGroupSequential` and `getSampleSizeSurvival`. *

**Solution:**

```{r, include=TRUE, echo=TRUE}
# basic parameters
infofrac <- c(0.6, 1)   # information fractions
alpha <- 0.05
beta <- 0.2
accrualTime <- c(0, 10)
accrualIntensity <- 48  # 48 pts over 10 months
randoratio <- 2         # 2:1 randomization
m2 <- 12                # median control
m1 <- 16.9              # median treatment
do <- 0.05              # dropout same in both arms
doTime <- 12            # time at which dropout happens
```

## Question 2

*Now add an interim analysis for futility ONLY (i.e. no stopping for efficacy possible) after 30% of information where we stop the trial if the observed hazard ratio is above 1.*

*Hint: Use significance levels from design with efficay only, add futility interim and use very small alpha there only. The argument `userAlphaSpending` in `getDesignGroupSequential` helps.*

**Solution:**

```{r, include=TRUE, echo=TRUE}
# provide your solution here
```


## Question 3

*How large is the power loss from adding this futility, assuming we would not increase the number of events compared to the initial design above?*

To compute the power loss of adding the futility, _conservatively_ assuming it will be adhered to, we compute the power of the design _with_ futility using the number of events of the design _without_ futility.

**Solution:**

```{r, include=TRUE, echo=TRUE}
# provide your solution here
```


## Question 4 

*How many OS events would be expected to occur until exactly 16 and 24 months, respectively, from first patient randomized?*

*Hint: `getEventProbabilities`.*

**Solution:**

```{r, include=TRUE, echo=TRUE}
# provide your solution here
```

